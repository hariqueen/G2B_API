name: Run Data Collection

on:
  schedule:
    # ë§¤ì¼ ì•„ì¹¨ 8ì‹œ(KST) = ë§¤ì¼ 23ì‹œ(UTC)
    - cron: '0 23 * * *'
  workflow_dispatch:  # ìˆ˜ë™ìœ¼ë¡œë„ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  collect-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create Firebase credentials file
        run: |
          echo '${{ secrets.FIREBASE_CREDENTIALS }}' > g2b-db-6aae9-firebase-adminsdk-fbsvc-0e3b1ce560.json
      
      - name: Run data collection script
        run: python main.py
      
      # ìˆ˜ì§‘ ê²°ê³¼ íŒŒì¼ ì½ê¸° (ë‹¤ì¤‘ í‚¤ì›Œë“œ ì§€ì›)
      - name: Read collection results
        id: read_results
        if: success()
        run: |
          if [ -f collection_result.json ]; then
            echo "TOTAL_COUNT=$(jq -r '.total_count' collection_result.json)" >> $GITHUB_OUTPUT
            echo "COLLECTION_DATE=$(jq -r '.collection_date' collection_result.json)" >> $GITHUB_OUTPUT
            
            # í‚¤ì›Œë“œë³„ ìˆ˜ì§‘ í˜„í™© ìƒì„±
            KEYWORD_RESULTS=""
            if [ "$(jq -r '.keyword_results' collection_result.json)" != "null" ]; then
              KEYWORD_RESULTS=$(jq -r '.keyword_results | to_entries[] | "â€¢ \(.key): \(.value)ê±´"' collection_result.json)
            fi
            
            # ê³µê³ ëª… ëª©ë¡ì„ ë¬¸ìì—´ë¡œ ë³€í™˜ (ìµœëŒ€ 20ê°œë¡œ ì œí•œ)
            BID_LIST=""
            if [ "$(jq -r '.total_count' collection_result.json)" -gt 0 ]; then
              BID_LIST=$(jq -r '.bid_details[:20][] | "â€¢ \(.ê³µê³ ëª…) (\(.ì±„ê¶Œìëª…))"' collection_result.json)
              TOTAL_BIDS=$(jq -r '.total_count' collection_result.json)
              if [ "$TOTAL_BIDS" -gt 20 ]; then
                BID_LIST="$BID_LIST"$'\n'"... ì™¸ $(($TOTAL_BIDS - 20))ê±´ ë”"
              fi
            else
              BID_LIST="ìˆ˜ì§‘ëœ ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤."
            fi
            
            # ì—¬ëŸ¬ ì¤„ ë¬¸ìì—´ì„ GitHub Outputì— ì €ì¥
            {
              echo 'KEYWORD_RESULTS<<EOF'
              echo "$KEYWORD_RESULTS"
              echo 'EOF'
            } >> $GITHUB_OUTPUT
            
            {
              echo 'BID_LIST<<EOF'
              echo "$BID_LIST"
              echo 'EOF'
            } >> $GITHUB_OUTPUT
          else
            echo "TOTAL_COUNT=0" >> $GITHUB_OUTPUT
            echo "COLLECTION_DATE=$(date)" >> $GITHUB_OUTPUT
            echo "KEYWORD_RESULTS=ê²°ê³¼ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." >> $GITHUB_OUTPUT
            echo "BID_LIST=ê²°ê³¼ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." >> $GITHUB_OUTPUT
          fi
      
      # ì„±ê³µ ì‹œì—ë„ ì´ë©”ì¼ ì•Œë¦¼ ë³´ë‚´ê¸° (ë‹¤ì¤‘ í‚¤ì›Œë“œ ì •ë³´ í¬í•¨)
      - name: Send Gmail notification on success
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "[G2B ìˆ˜ì§‘ì™„ë£Œ] ${{ steps.read_results.outputs.TOTAL_COUNT }}ê±´ ìˆ˜ì§‘ (ë‹¤ì¤‘í‚¤ì›Œë“œ)"
          body: |
            ğŸ‰ G2B ì…ì°° ë°ì´í„° ìˆ˜ì§‘ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
            
            ğŸ“Š ì „ì²´ ìˆ˜ì§‘ ê²°ê³¼:
            â€¢ ì´ ìˆ˜ì§‘ ê³µê³ : ${{ steps.read_results.outputs.TOTAL_COUNT }}ê±´
            â€¢ ìˆ˜ì§‘ ì™„ë£Œ ì‹œê°„: ${{ steps.read_results.outputs.COLLECTION_DATE }}
            
            ğŸ¯ í‚¤ì›Œë“œë³„ ìˆ˜ì§‘ í˜„í™©:
            ${{ steps.read_results.outputs.KEYWORD_RESULTS }}
            
            ğŸ“‹ ìˆ˜ì§‘ëœ ê³µê³  ëª©ë¡ (ìµœì‹  20ê±´):
            ${{ steps.read_results.outputs.BID_LIST }}
            
            ğŸ”— ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸í•˜ê¸°: https://g2b.onrender.com
            
            ---
            G2B ì…ì°° ë°ì´í„° ìë™ ìˆ˜ì§‘ ì‹œìŠ¤í…œ (ë‹¤ì¤‘í‚¤ì›Œë“œ ë²„ì „)
          to: hariqueen98@gmail.com
          from: G2B ìˆ˜ì§‘ì‹œìŠ¤í…œ
          
      # ì‹¤íŒ¨ ì‹œ ì´ë©”ì¼ ì•Œë¦¼ ë³´ë‚´ê¸°
      - name: Send Gmail notification on failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "[G2B ì˜¤ë¥˜] ë‹¤ì¤‘í‚¤ì›Œë“œ ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨"
          body: |
            âš ï¸ G2B ë‹¤ì¤‘í‚¤ì›Œë“œ ë°ì´í„° ìˆ˜ì§‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
            
            â€¢ ì‹¤í–‰ ì‹œê°„: ${{ github.event.repository.updated_at }}
            â€¢ ì›Œí¬í”Œë¡œìš°: ${{ github.workflow }}
            â€¢ ëŒ€ìƒ í‚¤ì›Œë“œ: ì½œì„¼í„°, CX, AICC, IT, ISP, ê³ ê°ê²½í—˜, ì»¨ì„¤íŒ…
            
            ğŸ”— ëŒ€ì‹œë³´ë“œ í™•ì¸: https://g2b.onrender.com
            
            GitHub Actions ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•´ ì£¼ì„¸ìš”.
            
            ---
            G2B ì…ì°° ë°ì´í„° ìë™ ìˆ˜ì§‘ ì‹œìŠ¤í…œ
          to: hariqueen98@gmail.com
          from: G2B ìˆ˜ì§‘ì‹œìŠ¤í…œ